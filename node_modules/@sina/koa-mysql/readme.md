# koa-mysql

##### 该模块依赖`mysql`，`co-mysql`，

``` json
"co-mysql": "1.0.0",
"mysql": "2.10.0"
```

所有操作为链式操作，支持分表，支持主从。其中 `insert`，`update`，`delete` 强制主库操作，`select`支持强制主库查询。





##### 配置

``` javascript
配置
  exports.dbConfig = {
      debug : false,    // 为TRUE时，会把执行的sql在控制台输出
      master : {
          host : 'localhost',
          port : 3306 ,
          database : 'database',
          user: 'root',
          password : 'root',
          connectionLimit: 10, // 数据库操作为连接池操作，主库最大连接数根据实际情况设置
          connectTimeout : 150, // 连接超时，单位milliseconds
      },
      slave : {
          host : 'localhost',
          port : 3306 ,
          database : 'database',
          user: 'root',
          password : 'root',
          connectionLimit: 50, // 数据库操作为连接池操作，从库最大连接数根据实际情况设置
          connectTimeout : 150, // 连接超时，单位milliseconds
      }
  }

初始化
    var mysql = require('@sina/koa-mysql');
    var dbConfig = require('./config').dbConfig;

    module.exports = function ( tableName, tableId ){
        mysqlObj = new mysql( dbConfig, tableName, tableId );
        return mysqlObj;
    }

使用
    var userDb = require('../config/mysql')('user');
    userDb.select().one();
```



##### 接口

`select(field)`

> 设置查询的字段
> 
> 参数：
> 
> > field : string 要查询的字段
> 
> 返回值：本身



`where(obj)`

> 设置查询条件
> 
> 参数：
> 
> > obj: object 查询条件，注意格式
> > 
> > ​        { id : 1 }
> > 
> > ​        { name : { sign: '>/>=/</<=', val: 2 } }
> > 
> > ​        { name : { sign: 'like', val: '%小明%' } 
> > 
> > ​        { id : { sign: 'in', val: [1,2] } 
> 
> 返回值：本身



`group(group)`

> 设置分组条件
> 
> 参数：
> 
> > group: string 分组条件
> 
> 返回值：本身



`orderBy(orderObj)`

> 设置排序条件
> 
> 参数：
> 
> > orderObj : Object 排序条件
> > 
> 
> 返回值：本身



`limit(page, pageSize)`

> 设置分页条件
> 
> 参数：
> 
> > page : number 页码，默认为1
> > 
> > pageSize：分页尺寸，默认为20
> 
> 返回值：本身



`one(master_or_slave)`

> 获取一条记录
> 
> 参数：
> 
> > master_or_slave: string 主从
> 
> 返回值：object



`all(master_or_slave)`

> 获取多条记录  
> 
> 参数：
> 
> > master_or_slave: string 主从
> 
> 返回值：object



`first(master_or_slave)`

> 获取一条数据的一个字段的值, 多个查询字段只返回第一个字段的值，参数为 * 的时候抛出错误
> 
> 参数：
> 
> > master_or_slave: string 主从
> 
> 返回值：string

``` javascript
var rs = yield db.select().where({id:1}).one();

var rs = yield db.select('name,city').where({city:{sign:'>',val:20}}).orderBy('id').all('master');
```



`insert( insertObj )`

> 插入数据
> 
> 强制主库操作
> 
> 参数：
> 
> > insertObj : object 要插入的数据
> 
> 返回值：Number 插入数据的id

``` 
var id = yield db.insert( {name:'小明',age:20,city:'北京'} );
```



`delete( whereObj )`

> 删除数据
> 
> 强制主库操作
> 
> 参数：
> 
> > whereObj : object 删除的条件，格式和`where`函数一样
> 
> 返回值：Number 删除数据的行数

``` javascript
var num = yield db.delete( {name:'小明'} );
```



`update( updateObj, whereObj )`

> 更新数据
> 
> 强制主库操作
> 
> 参数：
> 
> > updateObj : object 要更新的数据
> > 
> > whereObj : object 更新的条件，格式和`where`函数一样
> 
> 返回值：Number 影响行数

``` javascript
var num = yield db.update( {name:'小明2'}, {id:1} );
```



`query( sql, master_or_slave )`

> 手动执行sql
> 
> 参数：
> 
> > sql : string 要执行的sql
> > 
> > master_or_slave : string 主从
> 
> 返回值：object 

``` javascript
var rs = yield db.query('select version()');
```



`getSql`

> 获取刚运行的sql
> 
> 返回值：string 刚才运行的sql语句

``` javascript
var sql = yield db.getSql();
```



`getCountNum(master_or_slave)`

> 获取结果集的行数，在有查询条件的情况下，获取该查询条件下的总行数，没有的时候获取该表的总数目
> 
> 返回值：Number 返回上次查询的结果集行数

``` javascript
var countNum = yield db.getCountNum();
```

​